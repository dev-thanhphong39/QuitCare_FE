import React, { useEffect, useState } from "react";
import {
  Modal,
  Button,
  message,
  Card,
  Tag,
  Progress,
  Statistic,
  Row,
  Col,
  Switch,
} from "antd";
import {
  CalendarOutlined,
  TrophyOutlined,
  HeartOutlined,
  SmileOutlined,
  BugOutlined,
} from "@ant-design/icons";
import {
  format,
  startOfDay,
  differenceInDays,
  addDays,
  isBefore,
  isAfter,
  isSameDay,
  startOfMonth,
  endOfMonth,
  startOfWeek,
  endOfWeek,
  eachDayOfInterval,
  getMonth,
  getYear,
  addMonths,
  subMonths,
} from "date-fns";
import { vi } from "date-fns/locale";
import api from "../../configs/axios";
import Navbar from "../navbar/Navbar";
import Footer from "../footer/Footer";
import "./TrackingPage.css";

const SYMPTOMS = {
  SYMPTOM1: "Th√®m thu·ªëc l√°",
  SYMPTOM2: "Th√®m ƒÉn",
  SYMPTOM3: "Ho dai d·∫≥ng",
  SYMPTOM4: "Tri·ªáu ch·ª©ng c·∫£m c√∫m",
  SYMPTOM5: "Thay ƒë·ªïi t√¢m tr·∫°ng",
  SYMPTOM6: "T√°o b√≥n",
};

const SYMPTOM_MESSAGES = {
  SYMPTOM1:
    "Th√®m thu·ªëc l√† tri·ªáu ch·ª©ng b√¨nh th∆∞·ªùng khi b·∫°n ƒëang cai thu·ªëc. H√£y th·ª≠ nhai k·∫πo cao su ho·∫∑c ƒëi d·∫°o ƒë·ªÉ l√†m d·ªãu c·∫£m gi√°c n√†y.",
  SYMPTOM2:
    "Nicotin gi√∫p ƒëi·ªÅu ch·ªânh ƒë∆∞·ªùng huy·∫øt, n√™n khi cai thu·ªëc b·∫°n s·∫Ω c·∫£m th·∫•y th√®m ƒÉn h∆°n. H√£y duy tr√¨ ch·∫ø ƒë·ªô ƒÉn l√†nh m·∫°nh.",
  SYMPTOM3:
    "Ho nhi·ªÅu h∆°n l√† d·∫•u hi·ªáu t·ªët! Ph·ªïi b·∫°n ƒëang d·∫ßn ph·ª•c h·ªìi v√† l√†m s·∫°ch c√°c ch·∫•t ƒë·ªôc t·ªìn ƒë·ªçng.",
  SYMPTOM4:
    "B·∫°n c√≥ th·ªÉ th·∫•y h∆°i s·ªët, kh√≥ ch·ªãu - ƒë√¢y l√† ph·∫£n ·ª©ng t·ª± nhi√™n c·ªßa c∆° th·ªÉ khi kh√¥ng c√≤n nicotin.",
  SYMPTOM5:
    "C·∫£m th·∫•y c√°u g·∫Øt l√† ph·∫£n ·ª©ng ph·ªï bi·∫øn. H√£y th·ª≠ th∆∞ gi√£n, ƒëi b·ªô, tr√≤ chuy·ªán v·ªõi b·∫°n b√®.",
  SYMPTOM6:
    "Cai thu·ªëc c√≥ th·ªÉ l√†m ch·∫≠m ti√™u h√≥a. H√£y u·ªëng ƒë·ªß n∆∞·ªõc v√† ƒÉn nhi·ªÅu rau xanh, th·ª±c ph·∫©m gi√†u ch·∫•t x∆°.",
};

const TrackingPage = () => {
  const accountId = localStorage.getItem("accountId");
  const [plan, setPlan] = useState(null);
  const [loading, setLoading] = useState(true);
  const [smokingStatusId, setSmokingStatusId] = useState(null);
  const [trackingData, setTrackingData] = useState({});
  const [selectedDate, setSelectedDate] = useState(new Date());
  const [isModalVisible, setIsModalVisible] = useState(false);
  const [popupContent, setPopupContent] = useState("");
  const [todayData, setTodayData] = useState({
    cigarettes_smoked: "",
    symptoms: [],
    notes: "",
  });
  const [submitting, setSubmitting] = useState(false);
  const [stats, setStats] = useState({
    totalDays: 0,
    completedDays: 0,
    totalPoints: 0,
    averageProgress: 0,
  });

  // Th√™m test mode state
  const [isTestMode, setIsTestMode] = useState(
    localStorage.getItem(`testMode_${accountId}`) === "true"
  );

  // Th√™m state cho navigation th√°ng
  const [currentMonth, setCurrentMonth] = useState(new Date());

  useEffect(() => {
    if (accountId) {
      initializeData();
    } else {
      message.error("Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ xem trang theo d√µi.");
    }
  }, [accountId]);

  // Load d·ªØ li·ªáu c·ªßa ng√†y ƒë∆∞·ª£c ch·ªçn khi thay ƒë·ªïi selectedDate
  useEffect(() => {
    loadSelectedDateData();
  }, [selectedDate, trackingData]);

  const initializeData = async () => {
    try {
      setLoading(true);
      await Promise.all([
        fetchPlan(),
        fetchSmokingStatus(),
        loadTrackingData(),
      ]);
    } catch (error) {
      console.error("L·ªói kh·ªüi t·∫°o d·ªØ li·ªáu:", error);
    } finally {
      setLoading(false);
    }
  };

  // Load d·ªØ li·ªáu c·ªßa ng√†y ƒë∆∞·ª£c ch·ªçn v√†o form
  const loadSelectedDateData = () => {
    const dateStr = format(selectedDate, "yyyy-MM-dd");
    const selectedData = trackingData[dateStr];

    if (selectedData && selectedData.submitted) {
      setTodayData({
        cigarettes_smoked: selectedData.cigarettes_smoked.toString(),
        symptoms: selectedData.symptoms || [],
        notes: selectedData.notes || "",
      });
    } else {
      setTodayData({
        cigarettes_smoked: "",
        symptoms: [],
        notes: "",
      });
    }
  };

  // Toggle test mode
  const toggleTestMode = (checked) => {
    setIsTestMode(checked);
    localStorage.setItem(`testMode_${accountId}`, checked.toString());

    if (checked) {
      message.info("üîß ƒê√£ b·∫≠t ch·∫ø ƒë·ªô Test - C√≥ th·ªÉ nh·∫≠p d·ªØ li·ªáu cho m·ªçi ng√†y");
    } else {
      message.info("üîí ƒê√£ t·∫Øt ch·∫ø ƒë·ªô Test - Ch·ªâ nh·∫≠p ƒë∆∞·ª£c d·ªØ li·ªáu h√¥m nay");
    }
  };

  // L·∫•y k·∫ø ho·∫°ch cai thu·ªëc
  const fetchPlan = async () => {
    try {
      const response = await api.get(`/v1/customers/${accountId}/quit-plans`);
      if (response.data) {
        setPlan(response.data);
        return response.data;
      }
    } catch (error) {
      console.error("L·ªói l·∫•y k·∫ø ho·∫°ch:", error);
      message.error("Kh√¥ng th·ªÉ t·∫£i k·∫ø ho·∫°ch. Vui l√≤ng t·∫°o k·∫ø ho·∫°ch tr∆∞·ªõc.");
    }
    return null;
  };

  // L·∫•y smoking status
  const fetchSmokingStatus = async () => {
    try {
      const response = await api.get(`/smoking-status/account/${accountId}`);
      if (response.data && response.data.id) {
        setSmokingStatusId(response.data.id);
        return response.data.id;
      }
    } catch (error) {
      console.error("L·ªói l·∫•y smoking status:", error);
    }
    return null;
  };

  // Load d·ªØ li·ªáu theo d√µi t·ª´ localStorage
  const loadTrackingData = () => {
    const savedData = {};
    Object.keys(localStorage).forEach((key) => {
      if (key.startsWith(`tracking_${accountId}_`)) {
        const dateStr = key.replace(`tracking_${accountId}_`, "");
        try {
          savedData[dateStr] = JSON.parse(localStorage.getItem(key));
        } catch (e) {
          console.error("L·ªói parse d·ªØ li·ªáu:", e);
        }
      }
    });
    setTrackingData(savedData);
    calculateStats(savedData);
  };

  // T√≠nh to√°n th·ªëng k√™ (kh√¥ng bao g·ªìm d·ªØ li·ªáu test)
  const calculateStats = (data) => {
    // L·ªçc b·ªè d·ªØ li·ªáu test kh·ªèi th·ªëng k√™
    const realDataEntries = Object.entries(data).filter(
      ([_, value]) => !value.isTestData
    );

    const completedDays = realDataEntries.filter(
      ([_, value]) => value.submitted
    ).length;

    const totalPoints = realDataEntries.reduce(
      (sum, [_, value]) => sum + (value.points || 0),
      0
    );

    const averageProgress =
      completedDays > 0
        ? realDataEntries.reduce((sum, [_, value]) => {
            if (value.submitted && value.target > 0) {
              return (
                sum +
                Math.max(
                  0,
                  ((value.target - value.cigarettes_smoked) / value.target) *
                    100
                )
              );
            }
            return sum;
          }, 0) / completedDays
        : 0;

    setStats({
      totalDays: realDataEntries.length,
      completedDays,
      totalPoints,
      averageProgress: Math.round(averageProgress),
    });
  };

  // L·∫•y stage hi·ªán t·∫°i d·ª±a tr√™n ng√†y
  const getCurrentStage = (date) => {
    if (!plan || !plan.stages) return null;

    const planStartDate = new Date(plan.localDateTime);
    const daysDiff = differenceInDays(date, planStartDate);

    if (plan.systemPlan) {
      // K·∫ø ho·∫°ch h·ªá th·ªëng: m·ªói stage = 4 tu·∫ßn = 28 ng√†y
      const stageIndex = Math.floor(daysDiff / 28);
      return plan.stages[stageIndex] || plan.stages[plan.stages.length - 1];
    } else {
      // K·∫ø ho·∫°ch t·ª± t·∫°o: c·∫ßn parse week_range
      let totalDays = 0;
      for (const stage of plan.stages) {
        const stageDays = parseWeekRangeToDays(stage.week_range);
        if (daysDiff < totalDays + stageDays) {
          return stage;
        }
        totalDays += stageDays;
      }
      return plan.stages[plan.stages.length - 1];
    }
  };

  // Parse week range th√†nh s·ªë ng√†y
  const parseWeekRangeToDays = (weekRange) => {
    if (!weekRange) return 7;

    const match = weekRange.match(/(\d+)[-‚Äì](\d+)/);
    if (match) {
      const startWeek = parseInt(match[1]);
      const endWeek = parseInt(match[2]);
      return (endWeek - startWeek + 1) * 7;
    }

    const singleMatch = weekRange.match(/(\d+)/);
    if (singleMatch) {
      return 7; // 1 tu·∫ßn
    }

    return 7;
  };

  // X·ª≠ l√Ω thay ƒë·ªïi input
  const handleInputChange = (field, value) => {
    setTodayData((prev) => ({
      ...prev,
      [field]: value,
    }));
  };

  // X·ª≠ l√Ω thay ƒë·ªïi tri·ªáu ch·ª©ng
  const handleSymptomChange = (symptom, checked) => {
    setTodayData((prev) => ({
      ...prev,
      symptoms: checked
        ? [...prev.symptoms, symptom]
        : prev.symptoms.filter((s) => s !== symptom),
    }));
  };

  // T√≠nh ƒëi·ªÉm
  const calculatePoints = (smoked, target) => {
    const basePoints = 10;
    const smokedCount = parseInt(smoked) || 0;

    if (smokedCount <= target) {
      const savedCigs = target - smokedCount;
      return basePoints + 50 + savedCigs * 5;
    } else {
      const excessCigs = smokedCount - target;
      return Math.max(5, basePoints - excessCigs * 3);
    }
  };

  // L∆∞u d·ªØ li·ªáu theo d√µi
  const handleSubmit = async () => {
    const currentStage = getCurrentStage(selectedDate);
    if (!currentStage) {
      message.error("Kh√¥ng t√¨m th·∫•y giai ƒëo·∫°n ph√π h·ª£p.");
      return;
    }

    const cigarettes_smoked = parseInt(todayData.cigarettes_smoked) || 0;
    const points = calculatePoints(
      cigarettes_smoked,
      currentStage.targetCigarettes
    );
    const mainSymptom =
      todayData.symptoms.length > 0 ? todayData.symptoms[0] : "SYMPTOM1";

    setSubmitting(true);
    try {
      // Ch·ªâ g·ªçi API n·∫øu kh√¥ng ph·∫£i test mode ho·∫∑c l√† ng√†y h√¥m nay
      const isToday = isSameDay(selectedDate, new Date());

      if (!isTestMode || isToday) {
        // G·ªçi API l∆∞u progress
        const progressData = {
          date: format(selectedDate, "yyyy-MM-dd"),
          cigarettes_smoked,
          quitHealthStatus: mainSymptom,
          quitProgressStatus: "SUBMITTED",
          quitPlanStageId: currentStage.id,
          smokingStatusId,
        };

        await api.post("/quit-progress", progressData);
      }

      // L∆∞u v√†o localStorage
      const dateStr = format(selectedDate, "yyyy-MM-dd");
      const trackingEntry = {
        ...todayData,
        cigarettes_smoked,
        target: currentStage.targetCigarettes,
        points,
        submitted: true,
        submittedAt: new Date().toISOString(),
        stageId: currentStage.id,
        isTestData: isTestMode && !isToday, // ƒê√°nh d·∫•u d·ªØ li·ªáu test
      };

      localStorage.setItem(
        `tracking_${accountId}_${dateStr}`,
        JSON.stringify(trackingEntry)
      );

      // C·∫≠p nh·∫≠t state
      const newTrackingData = {
        ...trackingData,
        [dateStr]: trackingEntry,
      };
      setTrackingData(newTrackingData);
      calculateStats(newTrackingData);

      // C·∫≠p nh·∫≠t t·ªïng ƒëi·ªÉm (ch·ªâ cho d·ªØ li·ªáu th·∫≠t)
      if (!isTestMode || isToday) {
        const currentTotal = parseInt(
          localStorage.getItem(`total_points_${accountId}`) || "0"
        );
        const newTotal = currentTotal + points;
        localStorage.setItem(`total_points_${accountId}`, newTotal.toString());
      }

      // Hi·ªÉn th·ªã popup th√†nh c√¥ng
      showSuccessPopup(
        cigarettes_smoked,
        currentStage.targetCigarettes,
        points,
        0,
        isTestMode && !isToday
      );

      message.success(
        isTestMode && !isToday
          ? "üìù L∆∞u d·ªØ li·ªáu test th√†nh c√¥ng!"
          : "‚úÖ L∆∞u d·ªØ li·ªáu th√†nh c√¥ng!"
      );
    } catch (error) {
      console.error("L·ªói l∆∞u d·ªØ li·ªáu:", error);
      message.error("C√≥ l·ªói x·∫£y ra khi l∆∞u d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i!");
    } finally {
      setSubmitting(false);
    }
  };

  // Hi·ªÉn th·ªã popup th√†nh c√¥ng
  const showSuccessPopup = (
    smoked,
    target,
    points,
    totalPoints,
    isTestData = false
  ) => {
    const savedCigs = Math.max(0, target - smoked);
    const savedMoney = savedCigs * 1000;

    let content = "";

    if (isTestData) {
      content += `
        <div class="quit-tracking-test-notice">
          <h4>üîß Ch·∫ø ƒë·ªô Test - D·ªØ li·ªáu m·∫´u</h4>
          <p>D·ªØ li·ªáu n√†y ch·ªâ ƒë·ªÉ test giao di·ªán, kh√¥ng ·∫£nh h∆∞·ªüng ƒë·∫øn ƒëi·ªÉm th·∫≠t.</p>
        </div>
      `;
    }

    if (smoked <= target) {
      content += `
        <div class="quit-tracking-success-popup">
          <h3>üéâ Ch√∫c m·ª´ng! B·∫°n ƒë√£ ho√†n th√†nh m·ª•c ti√™u ${
            isTestData ? "m·∫´u" : "h√¥m nay"
          }!</h3>
          <p>üí∞ Ti·∫øt ki·ªám: ${savedMoney.toLocaleString()} VND</p>
          <p>‚≠ê ƒêi·ªÉm ${isTestData ? "m·∫´u" : "h√¥m nay"}: +${points}</p>
          ${!isTestData ? `<p>üèÜ T·ªïng ƒëi·ªÉm: ${totalPoints}</p>` : ""}
        </div>
      `;
    } else {
      content += `
        <div class="quit-tracking-warning-popup">
          <h3>‚ö†Ô∏è ${
            isTestData ? "D·ªØ li·ªáu m·∫´u:" : "H√¥m nay"
          } b·∫°n ƒë√£ h√∫t nhi·ªÅu h∆°n k·∫ø ho·∫°ch</h3>
          <p>ƒê·ª´ng n·∫£n l√≤ng! ${
            isTestData ? "ƒê√¢y ch·ªâ l√† test." : "Ng√†y mai h√£y c·ªë g·∫Øng h∆°n nh√©!"
          }</p>
          <p>‚≠ê ƒêi·ªÉm ${isTestData ? "m·∫´u" : "h√¥m nay"}: +${points}</p>
          ${!isTestData ? `<p>üèÜ T·ªïng ƒëi·ªÉm: ${totalPoints}</p>` : ""}
        </div>
      `;
    }

    // Th√™m th√¥ng tin v·ªÅ tri·ªáu ch·ª©ng
    if (todayData.symptoms.length > 0) {
      content += `
        <div class="quit-tracking-symptoms-popup">
          <h4>üåü Tri·ªáu ch·ª©ng ${isTestData ? "m·∫´u" : "h√¥m nay"}:</h4>
          ${todayData.symptoms
            .map(
              (symptom) => `
            <div class="quit-tracking-symptom-item">
              <strong>${SYMPTOMS[symptom]}</strong>
              <p>${SYMPTOM_MESSAGES[symptom]}</p>
            </div>
          `
            )
            .join("")}
        </div>
      `;
    }

    content += `
      <div class="quit-tracking-motivation-popup">
        <p><strong>üí™ ${
          isTestData
            ? "Test ho√†n t·∫•t!"
            : "B·∫°n ƒëang l√†m r·∫•t t·ªët! H√£y ti·∫øp t·ª•c ki√™n tr√¨!"
        }</strong></p>
      </div>
    `;

    setPopupContent(content);
    setIsModalVisible(true);
  };

  // Ki·ªÉm tra c√≥ th·ªÉ ch·ªânh s·ª≠a kh√¥ng - C·∫¨P NH·∫¨T LOGIC
  const canEdit = (date) => {
    // N·∫øu b·∫≠t test mode, cho ph√©p edit m·ªçi ng√†y
    if (isTestMode) {
      return true;
    }

    // Logic c≈© - ch·ªâ cho ph√©p edit h√¥m nay tr∆∞·ªõc 22h
    const today = startOfDay(new Date());
    const targetDate = startOfDay(date);

    if (isSameDay(targetDate, today)) {
      const now = new Date();
      return now.getHours() < 22;
    }

    return false;
  };

  // L·∫•y d·ªØ li·ªáu c·ªßa ng√†y ƒë∆∞·ª£c ch·ªçn
  const getSelectedDateData = () => {
    const dateStr = format(selectedDate, "yyyy-MM-dd");
    return trackingData[dateStr] || null;
  };

  // H√†m x√≥a d·ªØ li·ªáu test (ch·ªâ hi·ªán trong test mode)
  const clearTestData = () => {
    Modal.confirm({
      title: "üóëÔ∏è X√≥a d·ªØ li·ªáu test",
      content:
        "B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t·∫•t c·∫£ d·ªØ li·ªáu test? D·ªØ li·ªáu th·∫≠t s·∫Ω ƒë∆∞·ª£c gi·ªØ nguy√™n.",
      okText: "X√≥a",
      cancelText: "H·ªßy",
      okType: "danger",
      onOk: () => {
        let deletedCount = 0;
        const keysToRemove = [];

        // T√¨m t·∫•t c·∫£ key c·ªßa d·ªØ li·ªáu test
        Object.keys(localStorage).forEach((key) => {
          if (key.startsWith(`tracking_${accountId}_`)) {
            try {
              const data = JSON.parse(localStorage.getItem(key));
              if (data && data.isTestData === true) {
                keysToRemove.push(key);
              }
            } catch (e) {
              console.error("L·ªói parse d·ªØ li·ªáu:", e);
            }
          }
        });

        // X√≥a c√°c key ƒë√£ t√¨m th·∫•y
        keysToRemove.forEach((key) => {
          localStorage.removeItem(key);
          deletedCount++;
        });

        // C·∫≠p nh·∫≠t l·∫°i state
        loadTrackingData();

        // Reset form data n·∫øu ƒëang hi·ªÉn th·ªã d·ªØ li·ªáu test
        const currentDateStr = format(selectedDate, "yyyy-MM-dd");
        const currentData = JSON.parse(
          localStorage.getItem(`tracking_${accountId}_${currentDateStr}`) ||
            "null"
        );
        if (!currentData || currentData.isTestData) {
          setTodayData({
            cigarettes_smoked: "",
            symptoms: [],
            notes: "",
          });
        }

        if (deletedCount > 0) {
          message.success(`üßπ ƒê√£ x√≥a ${deletedCount} d·ªØ li·ªáu test!`);
        } else {
          message.info("‚ÑπÔ∏è Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu test n√†o ƒë·ªÉ x√≥a.");
        }
      },
    });
  };

  // Th√™m h√†m t√≠nh ng√†y k·∫øt th√∫c k·∫ø ho·∫°ch
  const getPlanEndDate = () => {
    if (!plan || !plan.stages || plan.stages.length === 0) return null;

    const startDate = new Date(plan.localDateTime);

    if (plan.systemPlan) {
      // K·∫ø ho·∫°ch h·ªá th·ªëng: m·ªói stage = 4 tu·∫ßn = 28 ng√†y
      const totalStages = plan.stages.length;
      const totalDays = totalStages * 28;
      return addDays(startDate, totalDays - 1); // -1 v√¨ ng√†y ƒë·∫ßu ti√™n ƒë∆∞·ª£c t√≠nh
    } else {
      // K·∫ø ho·∫°ch t·ª± t·∫°o: t√≠nh t·ªïng s·ªë ng√†y t·ª´ t·∫•t c·∫£ c√°c stage
      let totalDays = 0;
      for (const stage of plan.stages) {
        totalDays += parseWeekRangeToDays(stage.week_range);
      }
      return addDays(startDate, totalDays - 1);
    }
  };

  // Th√™m h√†m t√≠nh t·ªïng s·ªë ng√†y c·ªßa k·∫ø ho·∫°ch
  const getTotalPlanDays = () => {
    if (!plan || !plan.stages || plan.stages.length === 0) return 0;

    if (plan.systemPlan) {
      return plan.stages.length * 28;
    } else {
      let totalDays = 0;
      for (const stage of plan.stages) {
        totalDays += parseWeekRangeToDays(stage.week_range);
      }
      return totalDays;
    }
  };

  // H√†m ki·ªÉm tra ng√†y c√≥ trong k·∫ø ho·∫°ch kh√¥ng
  const isDateInPlan = (date) => {
    if (!plan) return false;

    const startDate = new Date(plan.localDateTime);
    const endDate = getPlanEndDate();

    return !isBefore(date, startDate) && (!endDate || !isAfter(date, endDate));
  };

  // Render calendar theo d·∫°ng l·ªãch th√°ng
  const renderCalendar = () => {
    if (!plan) return null;

    const monthStart = startOfMonth(currentMonth);
    const monthEnd = endOfMonth(monthStart);
    const startDate = startOfWeek(monthStart, { weekStartsOn: 1 }); // B·∫Øt ƒë·∫ßu t·ª´ th·ª© 2
    const endDate = endOfWeek(monthEnd, { weekStartsOn: 1 });

    const dateRange = eachDayOfInterval({ start: startDate, end: endDate });
    const today = new Date();

    // T·∫°o c√°c h√†ng c·ªßa l·ªãch (tu·∫ßn)
    const calendarRows = [];
    let days = [];

    dateRange.forEach((date, index) => {
      const dateStr = format(date, "yyyy-MM-dd");
      const dayData = trackingData[dateStr];
      const isSelected = isSameDay(date, selectedDate);
      const isToday = isSameDay(date, today);
      const isPast = isBefore(date, today);
      const isFuture = isAfter(date, today);
      const isCurrentMonth = getMonth(date) === getMonth(currentMonth);
      const isInPlan = isDateInPlan(date);

      days.push(
        <div
          key={dateStr}
          className={`
            quit-tracking-calendar-cell 
            ${isSelected ? "quit-tracking-cell-selected" : ""}
            ${isToday ? "quit-tracking-cell-today" : ""}
            ${!isCurrentMonth ? "quit-tracking-cell-other-month" : ""}
            ${!isInPlan ? "quit-tracking-cell-out-of-plan" : ""}
            ${isPast ? "quit-tracking-cell-past" : ""}
            ${isFuture ? "quit-tracking-cell-future" : ""}
          `}
          onClick={() => setSelectedDate(date)}
        >
          <div className="quit-tracking-cell-number">{format(date, "d")}</div>

          {/* Hi·ªÉn th·ªã tr·∫°ng th√°i */}
          {dayData && dayData.submitted && isInPlan && (
            <div
              className={`quit-tracking-cell-status ${
                dayData.cigarettes_smoked <= dayData.target
                  ? "quit-tracking-cell-success"
                  : "quit-tracking-cell-warning"
              }`}
            >
              {dayData.isTestData ? "üîß" : "‚úì"}
            </div>
          )}

          {/* Hi·ªÉn th·ªã stage indicator */}
          {isInPlan && (
            <div className="quit-tracking-cell-stage">
              {getCurrentStage(date)?.stageNumber || "-"}
            </div>
          )}
        </div>
      );

      // T·∫°o h√†ng m·ªõi sau m·ªói 7 ng√†y
      if ((index + 1) % 7 === 0) {
        calendarRows.push(
          <div
            key={`week-${calendarRows.length}`}
            className="quit-tracking-calendar-row"
          >
            {days}
          </div>
        );
        days = [];
      }
    });

    const planStartDate = new Date(plan.localDateTime);
    const planEndDate = getPlanEndDate();

    return (
      <div className="quit-tracking-calendar-container">
        {/* Header v·ªõi navigation */}
        <div className="quit-tracking-calendar-header">
          <div className="quit-tracking-calendar-nav">
            <Button
              type="text"
              icon={<span>‚Äπ</span>}
              onClick={() => setCurrentMonth(subMonths(currentMonth, 1))}
            />
            <h3>{format(currentMonth, "MMMM yyyy", { locale: vi })}</h3>
            <Button
              type="text"
              icon={<span>‚Ä∫</span>}
              onClick={() => setCurrentMonth(addMonths(currentMonth, 1))}
            />
          </div>

          <div className="quit-tracking-plan-summary">
            <span>üìÖ {format(planStartDate, "dd/MM/yyyy")}</span>
            {planEndDate && <span>üèÅ {format(planEndDate, "dd/MM/yyyy")}</span>}
          </div>
        </div>

        {/* Th√¥ng tin legend */}
        <div className="quit-tracking-calendar-legend">
          <span className="quit-tracking-legend-today">H√¥m nay</span>
          <span className="quit-tracking-legend-success">Ho√†n th√†nh</span>
          <span className="quit-tracking-legend-warning">Ch∆∞a ƒë·∫°t</span>
          <span className="quit-tracking-legend-out-plan">Ngo√†i k·∫ø ho·∫°ch</span>
          {isTestMode && (
            <span className="quit-tracking-legend-test">üîß Test</span>
          )}
        </div>

        {/* Header ng√†y trong tu·∫ßn */}
        <div className="quit-tracking-calendar-weekdays">
          {["T2", "T3", "T4", "T5", "T6", "T7", "CN"].map((day) => (
            <div key={day} className="quit-tracking-weekday-header">
              {day}
            </div>
          ))}
        </div>

        {/* L·ªãch th√°ng */}
        <div className="quit-tracking-calendar-grid">{calendarRows}</div>

        {/* Quick navigation */}
        <div className="quit-tracking-calendar-quick-nav">
          <Button
            size="small"
            type={isSameDay(currentMonth, new Date()) ? "primary" : "default"}
            onClick={() => setCurrentMonth(new Date())}
          >
            Th√°ng n√†y
          </Button>
          <Button
            size="small"
            type={
              isSameDay(currentMonth, planStartDate) ? "primary" : "default"
            }
            onClick={() => setCurrentMonth(planStartDate)}
          >
            Th√°ng b·∫Øt ƒë·∫ßu
          </Button>
          {planEndDate && (
            <Button
              size="small"
              type={
                isSameDay(currentMonth, planEndDate) ? "primary" : "default"
              }
              onClick={() => setCurrentMonth(planEndDate)}
            >
              Th√°ng k·∫øt th√∫c
            </Button>
          )}
        </div>
      </div>
    );
  };

  // Debug function ƒë·ªÉ ki·ªÉm tra d·ªØ li·ªáu test
  const debugTestData = () => {
    console.log("=== DEBUG TEST DATA ===");
    const testDataKeys = [];
    const realDataKeys = [];

    Object.keys(localStorage).forEach((key) => {
      if (key.startsWith(`tracking_${accountId}_`)) {
        try {
          const data = JSON.parse(localStorage.getItem(key));
          if (data.isTestData === true) {
            testDataKeys.push(key);
            console.log("Test data:", key, data);
          } else {
            realDataKeys.push(key);
            console.log("Real data:", key, data);
          }
        } catch (e) {
          console.error("L·ªói parse d·ªØ li·ªáu:", key, e);
        }
      }
    });

    console.log(
      `T·ªïng c√≥ ${testDataKeys.length} d·ªØ li·ªáu test v√† ${realDataKeys.length} d·ªØ li·ªáu th·∫≠t`
    );
    console.log("Test data keys:", testDataKeys);
    console.log("Real data keys:", realDataKeys);
    console.log("======================");
  };

  // H√†m ƒë·∫øm s·ªë l∆∞·ª£ng d·ªØ li·ªáu test
  const getTestDataCount = () => {
    let count = 0;
    Object.keys(localStorage).forEach((key) => {
      if (key.startsWith(`tracking_${accountId}_`)) {
        try {
          const data = JSON.parse(localStorage.getItem(key));
          if (data && data.isTestData === true) {
            count++;
          }
        } catch (e) {
          console.error("L·ªói parse d·ªØ li·ªáu:", e);
        }
      }
    });
    return count;
  };

  if (loading) {
    return (
      <>
        <Navbar />
        <div className="quit-tracking-main-container">
          <div className="quit-tracking-loading-container">
            <div className="quit-tracking-loading-spinner"></div>
            <p>ƒêang t·∫£i d·ªØ li·ªáu...</p>
          </div>
        </div>
        <Footer />
      </>
    );
  }

  if (!plan) {
    return (
      <>
        <Navbar />
        <div className="quit-tracking-main-container">
          <div className="quit-tracking-error-container">
            <h3>Ch∆∞a c√≥ k·∫ø ho·∫°ch cai thu·ªëc</h3>
            <p>Vui l√≤ng t·∫°o k·∫ø ho·∫°ch tr∆∞·ªõc khi theo d√µi ti·∫øn tr√¨nh.</p>
            <Button
              type="primary"
              onClick={() => (window.location.href = "/planning")}
            >
              T·∫°o k·∫ø ho·∫°ch
            </Button>
          </div>
        </div>
        <Footer />
      </>
    );
  }

  const currentStage = getCurrentStage(selectedDate);
  const selectedData = getSelectedDateData();
  const isEditable = canEdit(selectedDate);

  return (
    <>
      <Navbar />
      <div className="quit-tracking-main-container">
        <div className="quit-tracking-page-header">
          <h1>üìä Theo d√µi ti·∫øn tr√¨nh cai thu·ªëc</h1>
          <div className="quit-tracking-plan-info">
            <Tag color={plan.systemPlan ? "blue" : "green"}>
              {plan.systemPlan ? "K·∫ø ho·∫°ch h·ªá th·ªëng" : "K·∫ø ho·∫°ch t·ª± t·∫°o"}
            </Tag>
            <Tag color="orange">
              M·ª©c ƒë·ªô nghi·ªán:{" "}
              {plan.addictionLevel === "LOW"
                ? "Th·∫•p"
                : plan.addictionLevel === "MEDIUM"
                ? "Trung b√¨nh"
                : "Cao"}
            </Tag>
          </div>

          {/* Test Mode Toggle */}
          <div className="quit-tracking-test-controls">
            <div className="quit-tracking-test-toggle">
              <BugOutlined style={{ marginRight: 8 }} />
              <span>Ch·∫ø ƒë·ªô Test: </span>
              <Switch
                checked={isTestMode}
                onChange={toggleTestMode}
                checkedChildren="ON"
                unCheckedChildren="OFF"
              />
              {isTestMode && (
                <>
                  <Button
                    type="link"
                    danger
                    size="small"
                    onClick={clearTestData}
                    style={{ marginLeft: 8 }}
                  >
                    üßπ X√≥a d·ªØ li·ªáu test
                  </Button>
                  <Button
                    type="link"
                    size="small"
                    onClick={debugTestData}
                    style={{ marginLeft: 8 }}
                  >
                    üîç Debug
                  </Button>
                </>
              )}
            </div>
            {isTestMode && (
              <div className="quit-tracking-test-notice">
                ‚ÑπÔ∏è ƒêang ·ªü ch·∫ø ƒë·ªô Test - C√≥ th·ªÉ nh·∫≠p d·ªØ li·ªáu cho m·ªçi ng√†y ƒë·ªÉ test
                giao di·ªán
                <br />
                üìä Hi·ªán c√≥ {getTestDataCount()} d·ªØ li·ªáu test
              </div>
            )}
          </div>
        </div>

        {/* Th·ªëng k√™ t·ªïng quan */}
        <Row gutter={[16, 16]} className="quit-tracking-stats-row">
          <Col xs={24} sm={12} md={6}>
            <Card className="quit-tracking-stats-card">
              <Statistic
                title="T·ªïng s·ªë ng√†y"
                value={stats.totalDays}
                prefix={<CalendarOutlined />}
              />
            </Card>
          </Col>
          <Col xs={24} sm={12} md={6}>
            <Card className="quit-tracking-stats-card">
              <Statistic
                title="Ng√†y ho√†n th√†nh"
                value={stats.completedDays}
                prefix={<SmileOutlined />}
              />
            </Card>
          </Col>
          <Col xs={24} sm={12} md={6}>
            <Card className="quit-tracking-stats-card">
              <Statistic
                title="T·ªïng ƒëi·ªÉm"
                value={stats.totalPoints}
                prefix={<TrophyOutlined />}
              />
            </Card>
          </Col>
          <Col xs={24} sm={12} md={6}>
            <Card className="quit-tracking-stats-card">
              <Statistic
                title="Ti·∫øn ƒë·ªô trung b√¨nh"
                value={stats.averageProgress}
                suffix="%"
                prefix={<HeartOutlined />}
              />
            </Card>
          </Col>
        </Row>

        {/* Calendar */}
        {renderCalendar()}

        {/* Form nh·∫≠p li·ªáu */}
        <Card
          className="quit-tracking-form-card"
          title={`üìù Nh·∫≠p d·ªØ li·ªáu ng√†y ${format(selectedDate, "dd/MM/yyyy")} ${
            selectedData?.isTestData ? "(Test)" : ""
          }`}
        >
          {currentStage && (
            <div className="quit-tracking-stage-info">
              <Tag color="blue">Giai ƒëo·∫°n {currentStage.stageNumber}</Tag>
              <span>M·ª•c ti√™u: {currentStage.targetCigarettes} ƒëi·∫øu/ng√†y</span>
              {isTestMode && !isSameDay(selectedDate, new Date()) && (
                <Tag color="red">CH·∫æ ƒê·ªò TEST</Tag>
              )}
            </div>
          )}

          {selectedData && selectedData.submitted ? (
            <div className="quit-tracking-submitted-data">
              <h4>
                ‚úÖ D·ªØ li·ªáu ƒë√£ l∆∞u{selectedData.isTestData ? " (Test)" : ""}:
              </h4>
              <p>
                <strong>S·ªë ƒëi·∫øu ƒë√£ h√∫t:</strong>{" "}
                {selectedData.cigarettes_smoked}
              </p>
              <p>
                <strong>M·ª•c ti√™u:</strong> {selectedData.target} ƒëi·∫øu
              </p>
              <p>
                <strong>ƒêi·ªÉm:</strong> {selectedData.points}
              </p>
              {selectedData.symptoms && selectedData.symptoms.length > 0 && (
                <div>
                  <strong>Tri·ªáu ch·ª©ng:</strong>
                  {selectedData.symptoms.map((symptom) => (
                    <Tag key={symptom} color="orange">
                      {SYMPTOMS[symptom]}
                    </Tag>
                  ))}
                </div>
              )}
              {isEditable && (
                <Button
                  type="primary"
                  style={{ marginTop: 10 }}
                  onClick={() => {
                    setTodayData({
                      cigarettes_smoked:
                        selectedData.cigarettes_smoked.toString(),
                      symptoms: selectedData.symptoms || [],
                      notes: selectedData.notes || "",
                    });
                  }}
                >
                  ‚úèÔ∏è Ch·ªânh s·ª≠a
                </Button>
              )}
            </div>
          ) : isEditable ? (
            <div className="quit-tracking-input-form">
              <div className="quit-tracking-form-group">
                <label>S·ªë ƒëi·∫øu thu·ªëc ƒë√£ h√∫t:</label>
                <input
                  type="number"
                  min="0"
                  value={todayData.cigarettes_smoked}
                  onChange={(e) =>
                    handleInputChange("cigarettes_smoked", e.target.value)
                  }
                  placeholder="Nh·∫≠p s·ªë ƒëi·∫øu"
                  className="quit-tracking-form-input"
                />
              </div>

              <div className="quit-tracking-form-group">
                <label>Tri·ªáu ch·ª©ng g·∫∑p ph·∫£i:</label>
                <div className="quit-tracking-symptoms-grid">
                  {Object.entries(SYMPTOMS).map(([key, label]) => (
                    <label key={key} className="quit-tracking-symptom-checkbox">
                      <input
                        type="checkbox"
                        checked={todayData.symptoms.includes(key)}
                        onChange={(e) =>
                          handleSymptomChange(key, e.target.checked)
                        }
                      />
                      {label}
                    </label>
                  ))}
                </div>
              </div>

              <div className="quit-tracking-form-group">
                <label>Ghi ch√∫ (t√πy ch·ªçn):</label>
                <textarea
                  value={todayData.notes}
                  onChange={(e) => handleInputChange("notes", e.target.value)}
                  placeholder="Ghi ch√∫ v·ªÅ c·∫£m x√∫c, ho·∫°t ƒë·ªông..."
                  className="quit-tracking-form-textarea"
                />
              </div>

              <div className="quit-tracking-form-actions">
                <Button
                  type="primary"
                  size="large"
                  loading={submitting}
                  onClick={handleSubmit}
                  disabled={!todayData.cigarettes_smoked}
                >
                  üíæ{" "}
                  {isTestMode && !isSameDay(selectedDate, new Date())
                    ? "L∆∞u d·ªØ li·ªáu test"
                    : "L∆∞u d·ªØ li·ªáu h√¥m nay"}
                </Button>
              </div>
            </div>
          ) : (
            <div className="quit-tracking-cannot-edit">
              <p>‚è∞ Kh√¥ng th·ªÉ ch·ªânh s·ª≠a d·ªØ li·ªáu n√†y</p>
              <p>Ch·ªâ c√≥ th·ªÉ nh·∫≠p d·ªØ li·ªáu h√¥m nay v√† tr∆∞·ªõc 22:00</p>
              <p>üí° B·∫≠t ch·∫ø ƒë·ªô Test ƒë·ªÉ test v·ªõi m·ªçi ng√†y</p>
            </div>
          )}
        </Card>

        {/* Modal popup */}
        <Modal
          title="üì£ K·∫øt qu·∫£ h√¥m nay"
          open={isModalVisible}
          onCancel={() => setIsModalVisible(false)}
          footer={[
            <Button
              key="close"
              type="primary"
              onClick={() => setIsModalVisible(false)}
            >
              ƒê√≥ng
            </Button>,
          ]}
          width={600}
          centered
          className="quit-tracking-result-modal"
        >
          <div
            className="quit-tracking-popup-content"
            dangerouslySetInnerHTML={{ __html: popupContent }}
          />
        </Modal>
      </div>
      <Footer />
    </>
  );
};

export default TrackingPage;
